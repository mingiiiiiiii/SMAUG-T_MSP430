#include "ntt.h"

#include <stdint.h>

#include "parameters.h"

// static const int32_t zetas[SMAUG_N] = { 0,3653638, -4201138, 3795849, -173272, 3376145, -2135008, -2399134, -3239612,
// -1956312, -3836135, -1076080, 707318, -2129664, -3649776, 3679485, -3862763, -3214872, -1731429, 2223635, -2013603,
// 2050685, -3466184, 3620799, -2890907, 518931, -2784062, 157994, -3186567, 2443208, -1976439, -2138237, 3116754,
// -3645529, 2084045, -3681574, 3249093, -3761722, -3697259, 965302, 159644, 3583234, -3696649, -980578, 849279,
// -835404, 413429, 3790255, -1203290, 3298678, 3153004, -96284, 2680015, 3127077, 2917454, -2117568, 432021, -540694,
// -1893902, -2393616, -2252171, -4121955, 2268168, 215125, 978505, -666303, -3361544, 510879, -2317284, 2555482,
// -1106974, 975919, 1457767, 3519239, -4002012, 4200810, -2533941, 1167900, 1259684, 3507385, -628481, -2719462,
// -2136107, -3715897, 668971, -642989, -434930, 588595, 1233813, 1847310, -3188252, 1066751, 3551190, 2026470,
// -2422013, -3006831, 4027445, -3761478, -3252040, -2820710, 1002240, 2985005, 2584559, -1978286, -1382737, 882318,
// -307644, -2423268, -2513805, -510086, -4190480, -2921041, -571563, -478464, 3699255, 3139318, 3548270, -508488,
// 1136608, -2087977, 3723902, -2181242, -2482952, -1928258, 4175968, 2504130, 3159067, 3848909, 1055381, -637771,
// -2143434, 2709220, 2079901, 3612819, 1957445, 2240082, -364828, -646639, 2618999, 2935623, 1576929, -1410258,
// 3428811, 1923760, -2487417, -3530533, -553630, -3671732, -2989637, 1448344, -1656702, 426840, -3358983, -4076171,
// 3687854, 1203412, 2348220, 997476, -1616322, -3549222, 4096436, 3094305, 2092171, -530239, 1157772, -18124, -3308341,
// 1512862, 1016061, 1610367, 1563513, 1841539, -3962080, 1240493, 2992612, -2809077, 3269617, -1441518, -1802486,
// -1486345, -3737502, 1197456, -2818658, -124677, -167787, 3791455, -1263751, -3347958, -2012692, -3335537, -929464,
// -2140630, 120686, 2196442, 2660552, 3898296, 3388904, -707143, -2511623, 658825, -1911597, -3679803, -1412996,
// -1110005, 1506084, -422827, 810385, 3636264, 1742730, -3137828, -3485439, -1782966, 180027, -1225049, -2369793,
// 993103, -2604202, 981324, 1291531, 1674121, -2687514, -1940330, -4091766, 3089924, -2335696, 249619, 3358969,
// 3845257, 3258226, 2791081, -1008394, -26146, -4009857, 2082109, -2443, 1730472, 2795663, -926883, -1540167, 1397225,
// -767191, -3223577, -1390772, -768076, 2788915, -2962522, -3206599, 1033702, 542924, -2410216, -1619388, -3689430,
// -1569788, -2079150, 3575961, -2449565 };

static const int32_t zetas[LWE_N] = {
		0,				1029400, -297759, -318245, -519077, -1001589, -444108,	781285,		487886,		-789080, -159753, -187977,
		-288042,	-324055, -874026, -909157, -278055, 929166,		808407,		234136,		954449,		-872779, 338210,	695841,
		65764,		767487,	 -975181, -638917, -309744, 878699,		968347,		570345,		171628,		-354545, 478764,	-693668,
		677893,		345691,	 -650349, 104712,	 594630,	-842741,	62646,		329726,		213496,		303538,	 -445102, 161906,
		-22165,		-512654, -236514, 552714,	 555421,	-471792,	431484,		167576,		580780,		179295,	 486504,	-322679,
		915583,		-746824, -675557, -145764, 759180,	911655,		-87940,		-794449,	-208397,	-37146,	 -468305, 972641,
		16546,		856599,	 158449,	457765,	 -338398, 155194,		772939,		469209,		-618521,	-60500,	 483106,	-431797,
		469169,		-725990, 585400,	9808,		 -843944, -390857,	719127,		-38146,		411704,		-780507, -201745, -910643,
		-101239,	158708,	 -70753,	412948,	 -975552, 269316,		-1039005, -531557,	506917,		565342,	 -112248, 1050596,
		902039,		-819385, -670390, -589560, 839884,	-96942,		-863412,	-24143,		-127002,	-228319, 687948,	888724,
		705613,		-671231, 479683,	-774228, 926013,	-906594,	-993234,	-94431,		746556,		-240733, 539928,	-830793,
		308349,		-29321,	 -233836, -594335, 568212,	-198322,	-912430,	-169776,	-948183,	-913472, 262283,	142458,
		-725413,	797247,	 -86135,	501507,	 555594,	-1042565, -951987,	-861245,	-230142,	7860,		 904158,	-207166,
		-576367,	577085,	 -735950, 714887,	 475635,	-645737,	-49117,		23097,		-17928,		-390198, 180599,	-850568,
		-1010034, 712908,	 -126955, -966390, -942291, -894938,	440621,		-208098,	138466,		640979,	 -456505, -269820,
		127831,		-271918, 601745,	-830,		 959222,	-538940,	-33005,		-396969,	232529,		-340574, -620072, -919145,
		391271,		-594429, 213299,	-358269, -608643, 847876,		632308,		-1045185, 374335,		-467963, -688754, -257889,
		398864,		-418621, -761565, -476226, -107155, 1008843,	319360,		-818494,	-1040986, -360188, 1050283, -203282,
		537743,		-630109, 118945,	-663630, 794042,	-1028577, 855989,		174114,		-544121,	866818,	 -868332, -553163,
		-131493,	-788086, -892326, 608145,	 307029,	-581253,	-487766,	648233,		218452,		580179,	 890335,	-950351,
		974089,		-810999, 932670,	-472679, -775841, -319995,	-936315,	-764872,	528438,		-477499, 318750,	-627834,
		406269,		608222,	 264980,	1021826};

int32_t montgomery_reduce(int64_t a) {
	int32_t t;
	t = (int32_t)((uint64_t)a * (uint64_t)14675969);
	t = (a - (int64_t)t * 2101249) >> 32;
	return t;
}

/*************************************************
 * Name:        PQCLEAN_DILITHIUM3_CLEAN_ntt
 *
 * Description: Forward NTT, in-place. No modular reduction is performed after
 *              additions or subtractions. Output vector is in bitreversed order.
 *
 * Arguments:   - uint32_t p[N]: input/output coefficient array
 **************************************************/

void ntt(int32_t a[LWE_N]) {
	unsigned int len, start, j, k;
	int32_t zeta, t;

	k = 0;
	for (len = 128; len > 0; len >>= 1) {
		for (start = 0; start < LWE_N; start = j + len) {
			zeta = zetas[++k];
			for (j = start; j < start + len; ++j) {
				t = montgomery_reduce((int64_t)zeta * a[j + len]);
				a[j + len] = a[j] - t;
				a[j] = a[j] + t;
			}
		}
	}
}

/*************************************************
 * Name:        PQCLEAN_DILITHIUM3_CLEAN_invntt_tomont
 *
 * Description: Inverse NTT and multiplication by Montgomery factor 2^32.
 *              In-place. No modular reductions after additions or
 *              subtractions; input coefficients need to be smaller than
 *              Q in absolute value. Output coefficient are smaller than Q in
 *              absolute value.
 *
 * Arguments:   - uint32_t p[N]: input/output coefficient array
 **************************************************/

void invntt_tomont(int32_t a[LWE_N]) {
	unsigned int start, len, j, k;
	int32_t t, zeta;
	// const int32_t f = 41978; // mont^2/256
	const int32_t f = 671936;	 // mont^2/256 mod q : SABER
	k = 256;
	for (len = 1; len < LWE_N; len <<= 1) {
		for (start = 0; start < LWE_N; start = j + len) {
			zeta = -zetas[--k];
			for (j = start; j < start + len; ++j) {
				t = a[j];
				a[j] = t + a[j + len];
				a[j + len] = t - a[j + len];
				a[j + len] = montgomery_reduce((int64_t)zeta * a[j + len]);
			}
		}
	}

	for (j = 0; j < LWE_N; ++j) {
		a[j] = (montgomery_reduce((int64_t)f * a[j]));
	}
}
