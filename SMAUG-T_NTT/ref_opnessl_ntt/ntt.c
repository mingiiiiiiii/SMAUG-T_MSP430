#include "ntt.h"

#include <stdint.h>

#include "parameters.h"

int32_t zetas[LWE_N] = {0, 30934, 706601, -253095, 291139, 203499, -35823, -1369, 896679, -265664, -545027, 550672, -171598, 264064, 1126485, -1, 770539, 130236, 767335, -976200, -925373, -71036, -457784, 37, -1072811, -254964, -1099382, 50653, 528926, -334817, -1144558, -65536, 201922, 644605, -972619, 678171, -638239, 1174251, 528644, -350464, -809311, -114660, 1113402, 331718, -282094, -294940, -174967, -256, 846511, -607246, 26287, -149401, 738146, -1211385, -800720, 9472, -633487, 199707, -161164, 843003, -385592, -843997, 397945, 196615, -290484, 494944, -818549, 800146, -191442, 831151, -573168, -21904, -202134, 599042, 978900, -888580, -320735, -624642, 1049929, -16, 204459, -341057, 153195, -1070202, -256970, -1136576, -50045, 592, -191145, 770242, -616281, 810448, 1188317, -507406, 1085736, -1048576, 805919, 614348, -1012906, 1151404, -512492, -610648, 1183805, -757758, -824811, 590273, 840601, 457822, 336162, 130626, -374639, -4096, -1004822, -16604, 420592, 34417, -313829, 16504, -687355, 151552, -436460, 770479, -153791, -1060950, 1105027, 1045046, -907379, 721007, -72621, 123736, 401571, -1012380, 1164556, 813996, -143292, -5476, 1161883, -1062656, 244725, -222145, -686392, 1056256, -343726, -4, 657323, 520944, 644507, 944866, 1148174, -284144, 593697, 148, 558422, -1019856, 452138, 202612, -309129, 1085565, 271434, -262144, 807688, 153587, 959190, 287851, -128123, -152662, -310257, 1022977, -812411, -458640, -396058, -1097961, -1128376, -1179760, -699868, -1024, 961211, -4151, 105148, -597604, 527751, 4126, -778047, 37888, -109115, 798828, -644656, 947179, 882465, -951155, -833053, 786460, -1161936, -445057, -849363, 775751, -765768, 899771, 132161, -87616, -808536, -28665, -934066, -1129487, 1141893, -73735, -649950, -64, 817836, 1060605, 612780, 568858, -1027880, 303362, -200180, 2368, -764580, 656135, -40291, 816959, -96398, 395209, -506722, 655362, 798843, 32559, 798042, -244050, 374865, -17759, -114446, -606199, -874411, -63741, 937571, -593545, -1080185, 522504, 926277, -16384, 830378, -66416, -742465, 137668, 1169517, 66016, -324587, 606208, 678993, 657083, -615164, 605866, -429558, -669482, -1204683, 459195};

int32_t inv_zetas[LWE_N] = {588053, 588053, -30934, 588053, 253095, -30934, -706601, 588053, 1369, 253095, -203499, -30934, 35823, -706601, -291139, 588053, 1, 1369, -550672, 253095, -264064, -203499, 265664, -30934, -1126485, 35823, 545027, -706601, 171598, -291139, -896679, 588053, 65536, 1, -37, 1369, -50653, -550672, 976200, 253095, 334817, -264064, 71036, -203499, 254964, 265664, -130236, -30934, 1144558, -1126485, 457784, 35823, 1099382, 545027, -767335, -706601, -528926, 171598, 925373, -291139, 1072811, -896679, -770539, 588053, -196615, 65536, 256, 1, -9472, -37, 350464, 1369, -843003, -50653, -331718, -550672, 149401, 976200, -678171, 253095, 843997, 334817, 294940, -264064, 1211385, 71036, -1174251, -203499, -199707, 254964, 114660, 265664, 607246, -130236, -644605, -30934, -397945, 1144558, 174967, -1126485, 800720, 457784, -528644, 35823, 161164, 1099382, -1113402, 545027, -26287, -767335, 972619, -706601, 385592, -528926, 282094, 171598, -738146, 925373, 638239, -291139, 633487, 1072811, 809311, -896679, -846511, -770539, -201922, 588053, -721007, -196615, 1048576, 65536, 4096, 256, 16, 1, -151552, -9472, -592, -37, 757758, 350464, 21904, 1369, 1060950, -843003, -810448, -50653, -457822, -331718, 888580, -550672, -34417, 149401, 1070202, 976200, -1151404, -678171, -800146, 253095, -1045046, 843997, 507406, 334817, -130626, 294940, 624642, -264064, -16504, 1211385, 1136576, 71036, 610648, -1174251, -831151, -203499, -770479, -199707, -770242, 254964, -590273, 114660, -599042, 265664, 16604, 607246, 341057, -130236, -614348, -644605, -494944, -30934, 907379, -397945, -1085736, 1144558, 374639, 174967, -1049929, -1126485, 687355, 800720, 50045, 457784, -1183805, -528644, 573168, 35823, 153791, 161164, 616281, 1099382, -840601, -1113402, -978900, 545027, -420592, -26287, -153195, -767335, 1012906, 972619, 818549, -706601, -1105027, 385592, -1188317, -528926, -336162, 282094, 320735, 171598, 313829, -738146, 256970, 925373, 512492, 638239, 191442, -291139, 436460, 633487, 191145, 1072811, 824811, 809311, 202134, -896679, 1004822, -846511, -204459, -770539, -805919, -201922, 290484, 0};

int32_t twist_table[LWE_N] = {846511, 817836, 204459, 657323, 770539, 798843, 805919, 807688, 201922, -1161936, -290484, -72621, 588053, -459195, -721007, -786460, -196615, -655362, 1048576, 262144, 65536, 16384, 4096, 1024, 256, 64, 16, 4, 1, -606208, -151552, -37888, -9472, -2368, -592, -148, -37, 606199, 757758, -1022977, 350464, 87616, 21904, 5476, 1369, -605866, 1060950, -947179, -843003, -816959, -810448, -202612, -50653, 593545, -457822, 1097961, -331718, 1129487, 888580, 222145, -550672, -137668, -34417, 597604, 149401, -568858, 1070202, -944866, 976200, 244050, -1151404, -287851, -678171, -775751, -800146, 1012380, 253095, 669482, -1045046, 951155, 843997, -395209, 507406, -1085565, 334817, -522504, -130626, 1179760, 294940, 73735, 624642, -1056256, -264064, -66016, -16504, -4126, 1211385, -303362, 1136576, 284144, 71036, 17759, 610648, 152662, -1174251, -899771, -831151, -813996, -203499, -657083, -770479, -798828, -199707, -656135, -770242, 1019856, 254964, 63741, -590273, 458640, 114660, 28665, -599042, 1062656, 265664, 66416, 16604, 4151, 607246, -1060605, 341057, -520944, -130236, -32559, -614348, -153587, -644605, 445057, -494944, -123736, -30934, 1204683, 907379, 833053, -397945, 506722, -1085736, -271434, 1144558, -926277, 374639, 699868, 174967, 649950, -1049929, 343726, -1126485, 324587, 687355, 778047, 800720, 200180, 50045, -593697, 457784, 114446, -1183805, 310257, -528644, -132161, 573168, 143292, 35823, 615164, 153791, 644656, 161164, 40291, 616281, -452138, 1099382, -937571, -840601, 396058, -1113402, 934066, -978900, -244725, 545027, 742465, -420592, -105148, -26287, -612780, -153195, -644507, -767335, -798042, 1012906, -959190, 972619, 849363, 818549, -401571, -706601, 429558, -1105027, -882465, 385592, 96398, -1188317, 309129, -528926, 1080185, -336162, 1128376, 282094, -1141893, 320735, 686392, 171598, -1169517, 313829, -527751, -738146, 1027880, 256970, -1148174, 925373, -374865, 512492, 128123, 638239, 765768, 191442, -1164556, -291139, -678993, 436460, 109115, 633487, 764580, 191145, -558422, 1072811, 874411, 824811, 812411, 809311, 808536, 202134, -1161883, -896679, -830378, 1004822, -961211};

int32_t montgomery_reduce(int64_t a)
{
	int32_t t;
	t = (int32_t)((uint64_t)a * (uint64_t)NTT_QINV);
	t = (a - (int64_t)t * NTT_Q) >> 32;
	return t;
}

//* CT-butterfly in Forward-NTT
void ntt(int32_t a[LWE_N])
{
	unsigned int len, start, j, k;
	int32_t zeta, t;

	k = 0;
	for (len = 128; len > 0; len >>= 1)
	{
		for (start = 0; start < LWE_N; start = j + len)
		{
			zeta = zetas[++k];
			for (j = start; j < start + len; ++j)
			{
				t = montgomery_reduce((int64_t)zeta * a[j + len]);
				a[j + len] = a[j] - t;
				a[j] = a[j] + t;
			}
		}
	}
}

//* CT-butterfly in Inverse-NTT
void inv_ntt(int32_t a[LWE_N]) {
	unsigned int start, len, i, j, k;
	int32_t t, zeta;

	k = 0;
	for (len = 1; len < LWE_N; len <<= 1) {
		for (i = 0; i < len; i++) {
			zeta = inv_zetas[k++];
			for (j = 0; j < LWE_N / (len << 1); j++) {
                t = montgomery_reduce((int64_t)a[j * (len << 1) + i + len] * zeta);
				a[j * (len << 1) + i + len] = (a[j * (len << 1) + i] - t);
				a[j * (len << 1) + i] = (a[j * (len << 1) + i] + t);
			}
		}
	}

	//* twist (x^n - 1) to (x^n + 1), also multiply R^2
	for (j = 0; j < LWE_N; ++j) {
		a[j] = montgomery_reduce((int64_t)twist_table[j] * a[j]);
	}
}
